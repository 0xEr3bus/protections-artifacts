[rule]
description = """
Identifies process execution from a removable media and by an unusual process. Adversaries may move onto systems,
possibly those on disconnected or air-gapped networks, by copying malware to removable media and taking advantage of
Autorun features when the media is inserted into a system and executes.
"""
id = "5abc244c-78a4-44e6-8f96-e221e796608b"
license = "Elastic License v2"
name = "Execution from a Removable Media with Network Connection"
os_list = ["windows"]
version = "1.0.3"

query = '''
sequence by process.entity_id with maxspan=5m
 [process where event.action == "start" and

  (process.code_signature.trusted == false or process.code_signature.exists == false) and 
  
  not process.code_signature.status : ("errorExpired", "errorCode_endpoint*") and 

  (
   /* Direct Exec from USB */
   (process.Ext.device.bus_type : "usb" or process.Ext.device.product_id : "USB *") or

   /* Descendant of PE from USB */
   descendant of [process where event.action == "start" and 
                  (process.Ext.device.bus_type : "usb" or process.Ext.device.product_id : "USB *") and 
                  (process.code_signature.trusted == false or process.code_signature.exists==false)]
   ) and
   not process.parent.executable : ("?:\\Program Files (x86)\\Infinity Launcher\\Infinity Launcher.exe", "?:\\Program Files (x86)\\Steam\\steam.exe")
  ]
 [any where event.category == "network"]
'''

min_endpoint_version = "8.4.0"
optional_actions = []
[[actions]]
action = "kill_process"
field = "process.entity_id"
state = 0

[[threat]]
framework = "MITRE ATT&CK"
[[threat.technique]]
id = "T1091"
name = "Replication Through Removable Media"
reference = "https://attack.mitre.org/techniques/T1091/"


[threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

[internal]
min_endpoint_version = "8.4.0"
